<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Educe Library</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

window.firebaseApp = initializeApp({
  apiKey: "AIzaSyCqCPpNb0beFJui-qpShYqwgb6e5IS7PyU",
  authDomain: "tta-library.firebaseapp.com",
  projectId: "tta-library",
  storageBucket: "tta-library.firebasestorage.app",
  messagingSenderId: "803320543492",
  appId: "1:803320543492:web:5e1b19fcac2fe3846e7851"
});

window.db = getFirestore(firebaseApp);
</script>

<!-- QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,system-ui}
body{height:100vh;background:#0b0d10;color:#e5e7eb}

/* Splash */
#splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
background:radial-gradient(circle at top,#111827,#020617);z-index:1000}
#splash img{width:160px;animation:zoom 2.5s forwards}
#splash h1{margin-top:24px;font-size:2.5rem;background:linear-gradient(90deg,#007bff,#00c2ff);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;animation:fade 2s 1.2s forwards}
@keyframes zoom{from{transform:scale(.2);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fade{to{opacity:1}}

/* App */
#app{display:none;height:100%}

/* Topbar */
header{height:68px;background:#111827;display:flex;align-items:center;padding:0 40px;gap:32px}
header img{height:34px}
nav{display:flex;gap:24px}
nav button{background:none;border:none;color:#e5e7eb;font-size:.95rem;cursor:pointer;position:relative}
nav button::after{content:"";position:absolute;bottom:-6px;left:0;width:0;height:2px;background:#007bff;transition:.3s}
nav button:hover::after{width:100%}

/* Main */
main{padding:56px}
.actions{display:flex;gap:24px}
.action{padding:18px 44px;border-radius:16px;font-size:1.05rem;font-weight:600;border:none;cursor:pointer}
.primary{background:#007bff;color:white}
.secondary{background:#e5e7eb;color:#111827}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
.box{background:#020617;padding:36px;border-radius:18px;width:420px}
.box h2{margin-bottom:18px}
.box input{width:100%;padding:14px;border-radius:12px;border:1px solid #2a2f3a;background:#020617;color:white}
.box .row{margin-top:24px;display:flex;justify-content:flex-end;gap:12px}

/* QR */
#qr{width:320px;margin-top:20px}
</style>
</head>

<body>

<div id="splash">
  <img src="https://www.catamilacademy.org/images/tha_logo.png">
  <h1>Welcome to Educe Library</h1>
</div>

<div id="app">
<header>
  <img src="https://www.catamilacademy.org/images/tha_logo.png">
  <nav>
    <button onclick="location.href='studentcheck.html'">Student Check</button>
    <button onclick="location.href='booksout.html'">Books Out</button>
    <button onclick="location.href='history.html'">History</button>
  </nav>
</header>

<main>
  <div class="actions">
    <button class="action primary" onclick="startFlow('checkout')">Check Out Book</button>
    <button class="action secondary" onclick="startFlow('return')">Return Book</button>
  </div>
</main>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="box">
    <h2 id="title"></h2>
    <input id="input" placeholder="">
    <div id="qr"></div>
    <div class="row">
      <button class="action secondary" onclick="closeModal()">Cancel</button>
      <button class="action primary" onclick="next()">Continue</button>
    </div>
  </div>
</div>

<script type="module">
import { doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

let mode="",step=0,student="",book="",scanner;

window.startFlow = m => {
  mode=m; step=0;
  document.getElementById("title").innerText="Enter Student ID";
  document.getElementById("input").value="";
  document.getElementById("qr").innerHTML="";
  document.getElementById("modal").style.display="flex";
};

window.next = async () => {
  const val=document.getElementById("input").value.trim();
  if(step===0){
    student=val; step=1;
    document.getElementById("title").innerText="Scan Book QR or Enter Book ID";
    startQR();
  } else {
    book=val;
    await process();
  }
};

function startQR(){
  scanner=new Html5Qrcode("qr");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:220},code=>{
    book=code; scanner.stop(); process();
  });
}

async function process(){
  const ref=doc(db,"books",book);
  const snap=await getDoc(ref);

  if(mode==="checkout"){
    if(snap.exists() && snap.data().status==="out"){alert("Book already out");return;}
    await setDoc(ref,{status:"out",checkedOutBy:student,updatedAt:serverTimestamp()});
    await addDoc(collection(db,"history"),{studentId:student,bookId:book,action:"checkout",timestamp:serverTimestamp()});
  } else {
    if(!snap.exists() || snap.data().status==="available"){alert("Book already returned");return;}
    await updateDoc(ref,{status:"available",checkedOutBy:"",updatedAt:serverTimestamp()});
    await addDoc(collection(db,"history"),{studentId:student,bookId:book,action:"return",timestamp:serverTimestamp()});
  }

  closeModal();
  alert("Success");
}

window.closeModal=()=>{
  document.getElementById("modal").style.display="none";
  if(scanner) scanner.stop().catch(()=>{});
};

window.onload=()=>setTimeout(()=>{
  document.getElementById("splash").remove();
  document.getElementById("app").style.display="block";
},3000);
</script>

</body>
</html>
