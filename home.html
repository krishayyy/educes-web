<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamil School Library</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
/* ---------- RESET ---------- */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
html, body { height:100%; background:#0b0d10; color:#e5e7eb; overflow:hidden; }

/* ---------- SPLASH ---------- */
#splash { position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background:radial-gradient(circle,#111827,#020617); z-index:1000; }
#splash img { width:180px; transform:scale(0); animation:logoZoom 2s forwards; }
#welcomeText { margin-top:20px; font-size:2.5rem; font-weight:bold; background:linear-gradient(90deg,#004085,#007bff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; opacity:0; animation:textUnfold 2s 1s forwards; }
@keyframes logoZoom {0%{transform:scale(0);opacity:0;} 60%{transform:scale(1.2);opacity:1;} 100%{transform:scale(1);opacity:1;}}
@keyframes textUnfold {0%{opacity:0; transform:translateY(30px);}100%{opacity:1; transform:translateY(0);}}

/* ---------- APP ---------- */
#app { display:none; height:100vh; width:100vw; }

/* ---------- TOPBAR ---------- */
.topbar { display:flex; justify-content:space-between; align-items:center; height:68px; padding:0 40px; background:#111827; }
.topbar .logo img { height:36px; cursor:pointer; }
.nav { display:flex; gap:24px; }
.nav-btn { background:none; border:none; color:#e5e7eb; font-size:1rem; cursor:pointer; position:relative; padding:8px 4px; }
.nav-btn::after { content:""; position:absolute; bottom:0; left:0; width:0%; height:2px; background:#007bff; transition:width 0.3s; }
.nav-btn:hover::after { width:100%; }

/* ---------- MAIN ---------- */
.content { height:calc(100% - 68px); display:flex; justify-content:center; align-items:center; gap:30px; flex-wrap:wrap; }
.action { padding:20px 48px; font-size:1.2rem; font-weight:600; border-radius:14px; cursor:pointer; border:none; }
.primary { background:#111827; color:white; }
.secondary { background:#e5e7eb; color:#111827; }

/* ---------- MODAL ---------- */
.modal, #qrModal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:2000; }
.modal-box { width:400px; padding:32px; border-radius:16px; background:#020617; display:flex; flex-direction:column; gap:16px; }
.modal-box h2 { font-size:1.2rem; font-weight:600; }
.modal-box input { padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:#020617; color:white; font-size:1rem; }
.modal-actions { display:flex; justify-content:flex-end; gap:12px; }
.message { margin-top:8px; font-size:0.95rem; color:#00ff9c; min-height:18px; }
#qrScanner { width:100%; }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <img src="https://www.catamilacademy.org/images/tha_logo.png" alt="Logo">
  <div id="welcomeText">Welcome to Tamil School Library</div>
</div>

<!-- APP -->
<div id="app">
  <header class="topbar">
    <div class="logo">
      <img src="https://www.catamilacademy.org/images/tha_logo.png" alt="Logo">
    </div>
    <nav class="nav">
      <button class="nav-btn" onclick="window.location.href='studentcheck.html'">Student Check</button>
      <button class="nav-btn" onclick="window.location.href='booksout.html'">Books Out</button>
      <button class="nav-btn" onclick="window.location.href='history.html'">History</button>
    </nav>
  </header>

  <main class="content">
    <button class="action primary" id="checkOutBtn">Check Out Book</button>
    <button class="action secondary" id="returnBtn">Return Book</button>
  </main>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h2 id="modalTitle">Enter Student ID</h2>
    <input id="modalInput" placeholder="Student ID">
    <div class="message" id="modalMessage"></div>
    <div class="modal-actions">
      <button class="action secondary" id="closeModal">Cancel</button>
      <button class="action primary" id="nextStep">Continue</button>
    </div>
  </div>
</div>

<!-- QR MODAL -->
<div class="modal" id="qrModal">
  <div class="modal-box">
    <h2>Scan Book QR</h2>
    <div id="qrScanner"></div>
    <div class="modal-actions">
      <button class="action secondary" id="closeQR">Close</button>
    </div>
  </div>
</div>

<script>
// ---------- SPLASH ----------
window.addEventListener("load",()=>{setTimeout(()=>{document.getElementById("splash").remove();document.getElementById("app").style.display="block";},2500);});

// ---------- FIREBASE ----------
const firebaseConfig = {
  apiKey: "AIzaSyCqCPpNb0beFJui-qpShYqwgb6e5IS7PyU",
  authDomain: "tta-library.firebaseapp.com",
  projectId: "tta-library",
  storageBucket: "tta-library.firebasestorage.app",
  messagingSenderId: "803320543492",
  appId: "1:803320543492:web:5e1b19fcac2fe3846e7851",
  measurementId: "G-E988D3Z7ZQ"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------- GLOBAL ----------
let currentStudentID="", currentBookID="", actionType="";

// ---------- MODALS ----------
const modal=document.getElementById("modal"), qrModal=document.getElementById("qrModal");
const modalTitle=document.getElementById("modalTitle"), modalInput=document.getElementById("modalInput");
const modalMessage=document.getElementById("modalMessage");

function openStudentModal(action){
  actionType=action;
  modalTitle.textContent="Enter Student ID";
  modalInput.value="";
  modalMessage.textContent="";
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

// ---------- BUTTONS ----------
document.getElementById("checkOutBtn").onclick=()=>openStudentModal("checkout");
document.getElementById("returnBtn").onclick=()=>openStudentModal("return");
document.getElementById("closeModal").onclick=closeModal;

// ---------- NEXT STEP ----------
document.getElementById("nextStep").onclick=async ()=>{
  const studentID=modalInput.value.trim();
  if(!studentID){ modalMessage.textContent="Please enter Student ID."; return; }

  const studentDoc=await db.collection("students").doc(studentID).get();
  if(!studentDoc.exists){ modalMessage.textContent="Student ID not found."; return; }

  currentStudentID=studentID;
  modal.style.display="none";
  openQRModal();
}

// ---------- QR ----------
function openQRModal(){
  qrModal.style.display="flex";
  const html5QrCode=new Html5Qrcode("qrScanner");
  html5QrCode.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    async qrCodeMessage=>{
      currentBookID=qrCodeMessage.trim();
      const bookRef=db.collection("books").doc(currentBookID);
      const bookDoc=await bookRef.get();
      if(!bookDoc.exists){ alert("Book not found!"); html5QrCode.stop(); qrModal.style.display="none"; return; }

      if(actionType==="checkout" && bookDoc.data().status==="available"){
        await bookRef.update({status:"checked out", checkedOutBy:currentStudentID, timestamp:new Date()});
        await db.collection("history").add({studentID:currentStudentID, bookID:currentBookID, action:"checked out", timestamp:new Date()});
        alert(`${currentStudentID} checked out ${currentBookID}`);
      } else if(actionType==="return" && bookDoc.data().status==="checked out"){
        await bookRef.update({status:"available", checkedOutBy:"", timestamp:new Date()});
        await db.collection("history").add({studentID:currentStudentID, bookID:currentBookID, action:"returned", timestamp:new Date()});
        alert(`${currentStudentID} returned ${currentBookID}`);
      } else { alert("Action not allowed!"); }

      html5QrCode.stop();
      qrModal.style.display="none";
    },
    errorMessage=>{}
  );
}
document.getElementById("closeQR").onclick=()=>{ qrModal.style.display="none"; }
</script>

</body>
</html>
