<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDUCE Library</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', system-ui, sans-serif; }
html, body { height:100%; background:#0b0d10; color:#e5e7eb; overflow:hidden; }

/* SPLASH */
#splash { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle at top,#111827,#020617); z-index:1000; }
#logo { width:160px; transform:scale(0); animation:zoom 2.5s forwards; }
#welcomeText { margin-top:24px; font-size:2.5rem; font-weight:bold; background:linear-gradient(90deg,#007bff,#00c2ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; opacity:0; animation:fade 2s 1.2s forwards; }
@keyframes zoom { from{transform:scale(.2);opacity:0} to{transform:scale(1);opacity:1} }
@keyframes fade { to{opacity:1} }

/* APP */
#app { display:none; height:100vh; width:100vw; overflow:hidden; }

/* TOP BAR */
.topbar { display:flex; align-items:center; height:68px; padding:0 40px; background:#111827; }
.logo { display:flex; align-items:center; gap:12px; }
.logo img { height:36px; }
.nav { display:flex; gap:16px; margin-left:auto; }
.nav-btn { background:none; border:none; font-size:0.95rem; color:#e5e7eb; cursor:pointer; padding:8px 4px; position:relative; }
.nav-btn::after { content:""; position:absolute; bottom:0; left:0; width:0%; height:2px; background:#007bff; transition:width 0.3s ease; }
.nav-btn:hover::after { width:100%; }

/* MAIN */
.content { padding:48px; height:calc(100% - 68px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }
.actions { display:flex; gap:20px; flex-wrap:wrap; justify-content:center; }
.action { padding:18px 40px; border-radius:14px; border:none; font-size:1.1rem; cursor:pointer; font-weight:600; transition:all 0.2s ease; }
.action:hover { transform:scale(1.05); }
.primary { background:#007bff; color:white; }
.secondary { background:#e5e7eb; color:#111827; }

/* MODAL */
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:2000; }
.modal-box { width:420px; padding:36px; border-radius:18px; background:#020617; display:flex; flex-direction:column; gap:16px; }
.modal-box h2 { margin-bottom:8px; }
.modal-box p { color:#00ff9c; font-weight:600; }
.modal-box input { width:100%; padding:14px; border-radius:10px; background:#020617; border:1px solid rgba(255,255,255,0.15); color:white; }
.modal-actions { margin-top:16px; display:flex; justify-content:flex-end; gap:12px; }

/* QR SCANNER */
#qrScanner { width:100%; height:300px; margin-top:12px; border-radius:12px; }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <img src="https://www.catamilacademy.org/images/tha_logo.png" id="logo">
  <div id="welcomeText">Welcome to EDUCE Library</div>
</div>

<!-- APP -->
<div id="app">

  <header class="topbar">
    <div class="logo">
      <img src="https://www.catamilacademy.org/images/tha_logo.png">
      <span style="color:white;font-weight:600;">EDUCE Library</span>
    </div>
    <nav class="nav">
      <button class="nav-btn" onclick="window.location.href='studentcheck.html'">Student Check</button>
      <button class="nav-btn" onclick="window.location.href='booksout.html'">Books Out</button>
      <button class="nav-btn" onclick="window.location.href='history.html'">History</button>
    </nav>
  </header>

  <main class="content">
    <div class="actions">
      <button class="action primary" id="checkoutBtn">Check Out / Return</button>
    </div>
  </main>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h2 id="modalTitle">Enter Student ID</h2>
    <p id="studentName"></p>
    <p id="bookInfo"></p>
    <input id="modalInput" placeholder="Student ID">
    <div id="qrScanner"></div>
    <div class="modal-actions">
      <button class="action secondary" id="closeModal">Cancel</button>
      <button class="action primary" id="nextStep">Continue</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// ---------------- SPLASH ----------------
window.addEventListener("load", () => {
  setTimeout(() => {
    document.getElementById("splash").remove();
    document.getElementById("app").style.display = "flex";
  }, 3000);
});

// ---------------- FIREBASE ----------------
const firebaseConfig = {
  apiKey: "AIzaSyCqCPpNb0beFJui-qpShYqwgb6e5IS7PyU",
  authDomain: "tta-library.firebaseapp.com",
  projectId: "tta-library",
  storageBucket: "tta-library.firebasestorage.app",
  messagingSenderId: "803320543492",
  appId: "1:803320543492:web:5e1b19fcac2fe3846e7851"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- STATE ----------------
let step = 0;
let currentStudentID = "";
let currentStudentName = "";
let currentBookID = "";
let currentBookTitle = "";
let scanner = null;

const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalInput = document.getElementById("modalInput");
const studentNameDisplay = document.getElementById("studentName");
const bookInfoDisplay = document.getElementById("bookInfo");

// ---------------- FLOW ----------------
document.getElementById("checkoutBtn").onclick = async () => {
  step = 0;
  currentStudentID = "";
  currentStudentName = "";
  currentBookID = "";
  currentBookTitle = "";
  modalTitle.textContent = "Enter Student ID";
  modalInput.placeholder = "Student ID";
  modalInput.value = "";
  studentNameDisplay.textContent = "";
  bookInfoDisplay.textContent = "";
  modal.style.display = "flex";
  modalInput.focus();
};

document.getElementById("nextStep").onclick = async () => {
  const val = modalInput.value.trim();
  if(step === 0){
    // validate student
    const studentDoc = await db.collection("students").doc(val).get();
    if(!studentDoc.exists){ alert("Invalid Student ID!"); return; }
    currentStudentID = val;
    currentStudentName = studentDoc.data().name || "Unknown";
    studentNameDisplay.textContent = `Student: ${currentStudentName}`;
    step = 1;
    modalTitle.textContent = "Scan Book QR";
    modalInput.style.display = "none";

    // start QR scanner
    scanner = new Html5Qrcode("qrScanner");
    scanner.start(
      { facingMode:"environment" },
      { fps:10, qrbox:250 },
      async (decodedText) => {
        currentBookID = decodedText.trim();
        const bookDoc = await db.collection("books").doc(currentBookID).get();
        if(!bookDoc.exists){ alert("Book not found!"); return; }
        currentBookTitle = bookDoc.data().title || "Unknown";
        bookInfoDisplay.textContent = `Book: ${currentBookTitle}`;

        // Decide if checkout or return
        if(bookDoc.data().status === "available"){
          await db.collection("books").doc(currentBookID).update({ status:"checked out", checkedOutBy:currentStudentID, timestamp:new Date() });
          await db.collection("history").add({ studentID:currentStudentID, studentName:currentStudentName, bookID:currentBookID, bookTitle:currentBookTitle, action:"checkout", timestamp:new Date() });
          alert(`✅ ${currentStudentName} checked out "${currentBookTitle}"`);
        } else if(bookDoc.data().status === "checked out" && bookDoc.data().checkedOutBy === currentStudentID){
          await db.collection("books").doc(currentBookID).update({ status:"available", checkedOutBy:"", timestamp:new Date() });
          await db.collection("history").add({ studentID:currentStudentID, studentName:currentStudentName, bookID:currentBookID, bookTitle:currentBookTitle, action:"return", timestamp:new Date() });
          alert(`✅ ${currentStudentName} returned "${currentBookTitle}"`);
        } else {
          alert("Book is checked out by another student!");
        }
        closeModal();
      },
      errorMessage => {}
    );
  }
};

function closeModal(){
  modal.style.display = "none";
  modalInput.style.display = "block";
  modalInput.value = "";
  studentNameDisplay.textContent = "";
  bookInfoDisplay.textContent = "";
  step = 0;
  if(scanner) scanner.stop().catch(()=>{});
}

document.getElementById("closeModal").onclick = closeModal;
</script>
</body>
</html>
