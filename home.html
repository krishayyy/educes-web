<script>
// ==================== FIREBASE ====================
const firebaseConfig = {
  apiKey: "AIzaSyCqCPpNb0beFJui-qpShYqwgb6e5IS7PyU",
  authDomain: "tta-library.firebaseapp.com",
  projectId: "tta-library",
  storageBucket: "tta-library.firebasestorage.app",
  messagingSenderId: "803320543492",
  appId: "1:803320543492:web:5e1b19fcac2fe3846e7851"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ==================== GLOBAL STATE ====================
let state = {
  action: null,
  studentID: null,
  studentName: null,
  bookID: null,
  bookTitle: null,
  scanner: null,
  step: 0,
  scanning: false
};

// ==================== DOM ====================
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const studentNameDisplay = document.getElementById("studentName");
const bookInfoDisplay = document.getElementById("bookInfo");
const idInputSection = document.getElementById("idInputSection");
const qrScannerDiv = document.getElementById("qrScanner");
const hiddenInput = document.getElementById("hiddenInput");
const idDigits = document.querySelectorAll(".id-digit");
const booksGrid = document.getElementById("booksGrid");

// ==================== SPLASH ====================
window.addEventListener("load", () => {
  setTimeout(() => {
    document.getElementById("splash").remove();
    document.getElementById("app").style.display = "flex";
    startRealtimeBooks();
  }, 2500);
});

// ==================== REALTIME BOOKS + ANALYTICS ====================
function startRealtimeBooks() {
  db.collection("books").onSnapshot(snapshot => {

    booksGrid.innerHTML = "";

    let total = 0;
    let checkedOut = 0;

    snapshot.forEach(doc => {
      const book = doc.data();
      total++;

      if (book.status === "checked out") checkedOut++;

      const card = document.createElement("div");
      card.className = `book-card ${book.status === "checked out" ? "checked-out" : ""}`;

      card.innerHTML = `
        <div class="book-cover">ðŸ“–</div>
        <div class="book-title">${book.title || "Untitled"}</div>
        <span class="book-status ${book.status === "available" ? "available" : "unavailable"}">
          ${book.status === "available" ? "Available" : "Checked Out"}
        </span>
      `;

      booksGrid.appendChild(card);
    });

    console.log("ðŸ“Š Analytics:", {
      totalBooks: total,
      checkedOutBooks: checkedOut,
      availableBooks: total - checkedOut
    });

  }, error => {
    console.error("ðŸ”¥ Firestore Listener Error:", error);
    alert("Database connection error: " + error.message);
  });
}

// ==================== ACTION BUTTONS ====================
document.getElementById("checkoutBtn").onclick = () => openModal("checkout");
document.getElementById("returnBtn").onclick = () => openModal("return");

// ==================== OPEN MODAL ====================
function openModal(action) {
  state = { ...state, action, step: 0, studentID: null, bookID: null, scanning: false };

  modalTitle.textContent = "Enter Student ID";
  studentNameDisplay.textContent = "";
  bookInfoDisplay.textContent = "";

  idInputSection.classList.remove("hidden");
  qrScannerDiv.classList.add("hidden");

  setupIDInput();
  modal.classList.add("active");
}

// ==================== ID INPUT ====================
function setupIDInput() {
  hiddenInput.value = "";
  idDigits.forEach((digit, i) => {
    digit.textContent = "-";
    digit.classList.remove("filled", "active");
    if (i === 0) digit.classList.add("active");
  });
  hiddenInput.focus();
}

hiddenInput.addEventListener("input", e => {
  const value = e.target.value.replace(/\D/g, "").slice(0, 4);
  hiddenInput.value = value;

  idDigits.forEach((digit, index) => {
    digit.classList.remove("active", "filled");
    if (index < value.length) {
      digit.textContent = value[index];
      digit.classList.add("filled");
    } else {
      digit.textContent = "-";
    }
  });

  if (value.length < 4) idDigits[value.length]?.classList.add("active");
});

document.getElementById("nextStep").onclick = () => {
  if (state.step === 0) validateStudent();
};

// ==================== VALIDATE STUDENT ====================
async function validateStudent() {
  const id = hiddenInput.value.trim();

  if (id.length !== 4) return alert("Enter a valid 4-digit ID");

  try {
    const doc = await db.collection("students").doc(id).get();

    if (!doc.exists) return alert("Student not found");

    state.studentID = id;
    state.studentName = doc.data().name || "Student";

    studentNameDisplay.textContent = `Welcome, ${state.studentName}`;
    modalTitle.textContent = "Scan Book QR Code";

    idInputSection.classList.add("hidden");
    qrScannerDiv.classList.remove("hidden");

    state.step = 1;
    startScanner();

  } catch (error) {
    console.error("Student validation error:", error);
    alert("Database error: " + error.message);
  }
}

// ==================== QR SCANNER ====================
function startScanner() {
  if (state.scanning) return;

  state.scanning = true;
  state.scanner = new Html5Qrcode("qrScanner");

  state.scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async decodedText => {
      if (!state.bookID) {
        state.bookID = decodedText.trim();
        await handleBook();
      }
    }
  ).catch(err => {
    console.error("Camera error:", err);
    alert("Camera permission denied or unavailable.");
  });
}

// ==================== HANDLE BOOK ====================
async function handleBook() {
  try {
    const doc = await db.collection("books").doc(state.bookID).get();

    if (!doc.exists) return alert("Book not found.");

    const book = doc.data();
    state.bookTitle = book.title || "Unknown Book";
    bookInfoDisplay.textContent = `Book: ${state.bookTitle}`;

    if (state.action === "checkout") await checkoutBook(book);
    else await returnBook(book);

  } catch (error) {
    console.error("Book error:", error);
    alert("Error: " + error.message);
  }
}

// ==================== CHECKOUT ====================
async function checkoutBook(book) {

  if (book.status === "checked out")
    return alert("Book already checked out.");

  const batch = db.batch();

  const bookRef = db.collection("books").doc(state.bookID);
  batch.update(bookRef, {
    status: "checked out",
    checkedOutBy: state.studentID,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  const historyRef = db.collection("history").doc();
  batch.set(historyRef, {
    studentID: state.studentID,
    studentName: state.studentName,
    bookID: state.bookID,
    bookTitle: state.bookTitle,
    action: "checkout",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  await batch.commit();

  alert("Checkout successful!");
  closeModal();
}

// ==================== RETURN ====================
async function returnBook(book) {

  if (book.status === "available")
    return alert("Book is not checked out.");

  if (book.checkedOutBy !== state.studentID)
    return alert("Only the student who checked it out can return it.");

  const batch = db.batch();

  batch.update(db.collection("books").doc(state.bookID), {
    status: "available",
    checkedOutBy: "",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  batch.set(db.collection("history").doc(), {
    studentID: state.studentID,
    studentName: state.studentName,
    bookID: state.bookID,
    bookTitle: state.bookTitle,
    action: "return",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  await batch.commit();

  alert("Return successful!");
  closeModal();
}

// ==================== CLOSE ====================
function closeModal() {
  modal.classList.remove("active");

  if (state.scanner) {
    state.scanner.stop().catch(() => {});
  }

  state.scanning = false;
  state.bookID = null;
}

document.getElementById("closeModal").onclick = closeModal;

modal.addEventListener("click", e => {
  if (e.target === modal) closeModal();
});
</script>
