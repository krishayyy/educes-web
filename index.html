import React, { useState } from 'react';
import './App.css';
import axios from 'axios';

function App() {
  const [view, setView] = useState('home');
  const [age, setAge] = useState('');
  const [email, setEmail] = useState('');
  const [otp, setOtp] = useState('');
  const [otpSent, setOtpSent] = useState(false);
  const [otpVerified, setOtpVerified] = useState(false);
  const [userData, setUserData] = useState({
    firstName: '',
    lastName: '',
    username: '',
    password: '',
  });
  const [loggedInUser, setLoggedInUser] = useState(null);
  const [loginData, setLoginData] = useState({ username: '', password: '' });

  const sendOtp = async () => {
    try {
      await axios.post('http://localhost:4000/api/auth/send-otp', { email });
      setOtpSent(true);
    } catch (err) {
      alert('Error sending OTP');
    }
  };

  const verifyOtp = async () => {
    try {
      await axios.post('http://localhost:4000/api/auth/verify-otp', { email, otp });
      setOtpVerified(true);
    } catch (err) {
      alert('Invalid OTP');
    }
  };

  const register = async () => {
    try {
      await axios.post('http://localhost:4000/api/auth/register', { email, ...userData });
      alert('Registered successfully');
      setView('login');
    } catch (err) {
      alert('Error registering');
    }
  };

  const login = async () => {
    try {
      const res = await axios.post('http://localhost:4000/api/auth/login', loginData);
      setLoggedInUser(res.data.user);
      setView('dashboard');
    } catch (err) {
      alert('Invalid credentials');
    }
  };

  return (
    <div className="app">
      {view === 'home' && (
        <div className="home">
          <h1>Welcome to Educe</h1>
          <p>Free, live, 24/7 support for students. Founded by Krishay.</p>
          <img src="/hero-image.png" alt="Education banner" />
          <div className="btns">
            <button onClick={() => setView('signup-age')}>Sign Up</button>
            <button onClick={() => setView('login')}>Log In</button>
          </div>
        </div>
      )}

      {view === 'signup-age' && (
        <div className="form">
          <h2>Enter your age</h2>
          <input value={age} onChange={(e) => setAge(e.target.value)} placeholder="Age" />
          <button onClick={() => setView('signup-email')}>Next</button>
          <button className="back" onClick={() => setView('home')}>Back</button>
        </div>
      )}

      {view === 'signup-email' && (
        <div className="form">
          <h2>{age < 13 ? 'Enter parent email' : 'Enter your email'}</h2>
          <input value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" />
          <button onClick={sendOtp}>Send OTP</button>
          <button className="back" onClick={() => setView('signup-age')}>Back</button>
        </div>
      )}

      {otpSent && !otpVerified && (
        <div className="form">
          <h2>Enter the OTP sent to {email}</h2>
          <input value={otp} onChange={(e) => setOtp(e.target.value)} placeholder="OTP" />
          <button onClick={verifyOtp}>Verify</button>
          <button onClick={sendOtp}>Resend OTP</button>
        </div>
      )}

      {otpVerified && view !== 'register' && setView('register')}

      {view === 'register' && (
        <div className="form">
          <h2>Sign Up</h2>
          <input placeholder="First Name" onChange={(e) => setUserData({ ...userData, firstName: e.target.value })} />
          <input placeholder="Last Name" onChange={(e) => setUserData({ ...userData, lastName: e.target.value })} />
          <input placeholder="Username" onChange={(e) => setUserData({ ...userData, username: e.target.value })} />
          <input type="password" placeholder="Password" onChange={(e) => setUserData({ ...userData, password: e.target.value })} />
          <button onClick={register}>Submit</button>
        </div>
      )}

      {view === 'login' && (
        <div className="form">
          <h2>Login</h2>
          <input placeholder="Username" value={loginData.username} onChange={(e) => setLoginData({ ...loginData, username: e.target.value })} />
          <input type="password" placeholder="Password" value={loginData.password} onChange={(e) => setLoginData({ ...loginData, password: e.target.value })} />
          <button onClick={login}>Log In</button>
          <button className="back" onClick={() => setView('home')}>Back</button>
        </div>
      )}

      {view === 'dashboard' && loggedInUser && (
        <div className="dashboard">
          <h1>Welcome, {loggedInUser.firstName}</h1>
          <p>You are now signed in as {loggedInUser.username}</p>
          <div className="user-card">
            <p><strong>Full Name:</strong> {loggedInUser.firstName} {loggedInUser.lastName}</p>
            <p><strong>Email:</strong> {loggedInUser.email}</p>
            <p><strong>Username:</strong> {loggedInUser.username}</p>
          </div>
          <button onClick={() => setView('home')}>Log Out</button>
        </div>
      )}
    </div>
  );
}

export default App;
