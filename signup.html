<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signup | EDUCE</title>
  <style>
    .section { display: none; }
    .visible { display: block; }
    .status-icon { font-size: 18px; margin-left: 5px; }
  </style>
</head>
<body>
  <h2>Signup</h2>

  <!-- Section 1: Role & Birthday -->
  <div id="initialInfo" class="section visible">
    <label for="role">I'm signing up as:</label>
    <select id="role" onchange="checkBirthday()">
      <option value="learner">Learner</option>
      <option value="parent">Parent</option>
      <option value="tutor">Tutor</option>
    </select><br><br>

    <label>Birth Month:</label>
    <select id="birthMonth" onchange="checkBirthday()">
      <option value="">--Select--</option>
      <!-- 1 to 12 -->
      ${[...Array(12)].map((_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
    </select>

    <label>Birth Year:</label>
    <select id="birthYear" onchange="checkBirthday()">
      <option value="">--Select--</option>
      <!-- 2005 to 2022 -->
      ${[...Array(18)].map((_, i) => {
        const year = 2022 - i;
        return `<option value="${year}">${year}</option>`;
      }).join('')}
    </select><br><br>

    <div id="parentEmailSection" style="display:none;">
      <label>Parent's Email (required for under 13):</label>
      <input type="email" id="parentEmail" /><br><br>
    </div>

    <label>Email Address:</label>
    <input type="email" id="userEmail" /><br><br>

    <button onclick="sendOTP()">Send OTP</button>
  </div>

  <!-- Section 2: OTP -->
  <div id="otpSection" class="section">
    <h3>Enter the 6-digit OTP sent to your email:</h3>
    <div>
      ${[...Array(6)].map((_, i) => `<input type="text" id="otp${i}" maxlength="1" size="1" />`).join(' ')}
    </div><br>
    <button onclick="verifyOTP()">Verify</button>
  </div>

  <!-- Section 3: Final Signup -->
  <div id="finalSignup" class="section">
    <label>First Name:</label>
    <input type="text" id="firstName" /><br><br>

    <label>Last Name:</label>
    <input type="text" id="lastName" /><br><br>

    <label>Username (3-8 chars):</label>
    <input type="text" id="username" oninput="checkUsernameAvailability()" />
    <span id="usernameStatus" class="status-icon">❌</span><br><br>

    <label>Password (min 6):</label>
    <input type="password" id="password" /><br><br>

    <label>Confirm Password:</label>
    <input type="password" id="confirmPassword" /><br><br>

    <button onclick="submitSignup()">Create Account</button>
  </div>

  <script>
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('visible'));
      document.getElementById(id).classList.add('visible');
    }

    function checkBirthday() {
      const year = parseInt(document.getElementById('birthYear').value);
      const month = parseInt(document.getElementById('birthMonth').value);
      if (!year || !month) return;

      const birthDate = new Date(year, month - 1);
      const ageDiff = new Date().getFullYear() - year;
      const parentEmailSection = document.getElementById('parentEmailSection');
      if (ageDiff < 13) {
        parentEmailSection.style.display = 'block';
      } else {
        parentEmailSection.style.display = 'none';
      }
    }

    function sendOTP() {
      const email = document.getElementById('userEmail').value.trim();
      if (!email.includes('@')) return alert('Enter a valid email.');

      fetch('http://localhost:4000/api/send-otp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          showSection('otpSection');
        } else {
          alert('Failed to send OTP.');
        }
      }).catch(() => alert('Error sending OTP.'));
    }

    function verifyOTP() {
      let otp = '';
      for (let i = 0; i < 6; i++) {
        otp += document.getElementById(`otp${i}`).value;
      }
      if (otp.length < 6) return alert('Enter the full 6-digit code.');

      const email = document.getElementById('userEmail').value.trim();
      fetch('http://localhost:4000/api/verify-otp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, otp })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          showSection('finalSignup');
        } else {
          alert('Invalid OTP.');
        }
      }).catch(() => alert('Error verifying OTP.'));
    }

    function checkUsernameAvailability() {
      const username = document.getElementById('username').value.trim();
      const status = document.getElementById('usernameStatus');
      if (username.length < 3 || username.length > 8) {
        status.textContent = '❌';
        return;
      }

      fetch('http://localhost:4000/api/check-username', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      }).then(res => res.json()).then(data => {
        status.textContent = data.available ? '✅' : '❌';
      }).catch(() => status.textContent = '❌');
    }

    function submitSignup() {
      const email = document.getElementById('userEmail').value.trim();
      const parentEmail = document.getElementById('parentEmail').value.trim();
      const username = document.getElementById('username').value.trim();
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const role = document.getElementById('role').value;
      const birthMonth = parseInt(document.getElementById('birthMonth').value);
      const birthYear = parseInt(document.getElementById('birthYear').value);

      if (!firstName || !lastName || !username || !password || !confirmPassword) {
        return alert('Please fill out all fields.');
      }
      if (password !== confirmPassword) {
        return alert('Passwords do not match.');
      }
      if (username.length < 3 || username.length > 8) {
        return alert('Username must be 3–8 characters.');
      }
      if (password.length < 6) {
        return alert('Password must be at least 6 characters.');
      }

      fetch('http://localhost:4000/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          parentEmail: parentEmail || null,
          username,
          firstName,
          lastName,
          password,
          role,
          birthMonth,
          birthYear
        })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          alert('Account created! Redirecting...');
          window.location.href = '/dashboard'; // or wherever you want
        } else {
          alert(data.message || 'Registration failed.');
        }
      }).catch(() => alert('Network error during registration.'));
    }
  </script>
</body>
</html>
